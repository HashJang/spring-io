# 不再需要密码，针对 Spring 开发者的 Passkey 说明
Passkey 是一种全新的无密码身份认证技术,旨在彻底取代传统的基于密码的认证方式。它利用公钥加密算法和密钥对(包括公钥和私钥)来实现安全、便捷的身份验证。

## 1. **公钥加密基础**

Passkey 建立在公钥加密技术的基础之上。公钥加密使用一对数学上相关的密钥,即公钥和私钥。公钥可以公开,而私钥必须保密。使用公钥加密的数据只能由对应的私钥解密,反之亦然。公钥加密除了可用于加密数据外,还可用于数字签名认证。在数字签名中,用户使用其私钥对数据进行签名,接收方使用该用户的公钥验证签名,从而确认数据的完整性和发送者的身份。由于私钥难以被伪造,因此数字签名比传统手写签名更加可靠和安全。

后面我们会在具体流程看到，公钥私钥在认证器中生成，私钥存储在认证器中，公钥发送给服务器。后续认证的时候，使用私钥对挑战进行签名，服务器使用公钥验证签名，从而确认用户身份。

2. **认证器(Authenticator)**

认证器是能够创建和存储公钥-私钥对的硬件或软件。Passkey 使用两种类型的认证器:

- **平台认证器(Platform Authenticator)**: 内置于设备(如智能手机、笔记本电脑等)中的不可移除认证器,例如 Touch ID、Face ID、Windows Hello 等。
- **可移动认证器(Roaming Authenticator)**: 可移除的外部认证器设备,如 YubiKey,可通过 USB、蓝牙、NFC 等与平台连接。

3. **FIDO 标准**

FIDO(Fast IDentity Online)是一套全球统一的无密码身份认证标准,由 FIDO 联盟制定,联盟成员包括安全专业人士、安全公司和主要科技公司。FIDO 联盟的目标是让互联网更安全,并通过公钥加密技术替代密码认证。

目前使用的是 FIDO2 标准,它包括两个子标准:WebAuthn(Web Authentication,W3C 标准)和 CTAP(Client to Authenticator Protocol)。

4. **WebAuthn 架构**

WebAuthn 标准为 Passkey 的实现提供了基础。它定义了一组 JavaScript API,允许浏览器与认证器通信。WebAuthn 架构由三个主要部分组成:

- **认证器(Authenticator)**: 前文已介绍过,可以是平台认证器或可移动认证器。
- **依赖方(Relying Party)**: 需要进行身份验证的服务器,可以是您自己的服务器或身份提供商(IdP)服务器。
- **客户端(Client)**: 由浏览器和用户组成,负责在认证器和依赖方之间进行协调。

5. **Passkey 工作流程**

Passkey 包含两个主要流程:注册和认证。

**注册流程**:

1) 用户访问网站并点击注册。
2) 客户端向服务器请求一个随机挑战(Challenge)。随机挑战理论上是一个随机数组，用于确保每次注册请求都是唯一的，实际一般是一个 Base64 编码的字符串。
3) 客户端触发 WebAuthn API 的 `navigator.credentials.create` 方法，将随机挑战传入。
4) 用户使用认证器(如指纹、面部等)进行用户验证。
5) 认证器(平台认证器或可移动认证器)会为该网站创建一对全新的公钥-私钥对
6) 认证器将生成的私钥安全存储在本地(如手机安全芯片或 YubiKey 设备中)
7) 认证器创建一个包含公钥，凭据（Credential）ID，还有私钥加密的挑战的 "attestation" 响应，发送回客户端。
8) 客户端将 attestation 发送回服务器，服务器验证 attestation 的有效性，如果有效，将公钥和凭据 ID 存储。

服务器只保存了公钥和凭据 ID，即使服务器被攻击导致数据泄漏，也无法获取到用户的私钥，只有公钥也做不了什么，因此安全性更高。

**认证流程**:

1) 用户访问网站并点击登录。
2) 客户端向服务器请求一个新的随机挑战。
3) 客户端触发 WebAuthn API 的 `navigator.credentials.get` 方法。
4) 用户使用相同的认证器进行用户验证。
5) 认证器使用存储的私钥对挑战进行数字签名。
6) 认证器将签名后的挑战等数据作为断言(Assertion)发送回客户端，之后发送回服务器端，服务器使用公钥验证签名，从而确认用户身份。

6. **Passkey 优势**

相比传统密码认证,Passkey 具有以下显著优势:

- **防止网络钓鱼攻击**: 由于密钥绑定了特定域名,钓鱼网站无法获取用户的 Passkey 凭据。
- **防止远程攻击**: 需要物理认证器的存在,无法远程访问私钥。
- **提高数据安全性**: 服务器端无需存储敏感凭据(如密码),降低数据泄露风险。
- **无凭据重用**: 每个服务使用唯一的密钥对,绑定了域名和用户身份。
- **易于管理**: 对于同步 Passkey,无需实现密码重置或多因素认证流程。

7. **Passkey 类型**

目前有两种 Passkey 类型:

- **同步 Passkey (Sync Passkey)**: 私钥通过云服务(如 iCloud、Google 密码管理器)在用户设备间同步,提高便利性,但略微降低安全性。
- **设备绑定 Passkey (Device-Bound Passkey)**: 私钥仅存储在单个认证器中(如 YubiKey),安全性最高,但便利性较低,无备份或恢复方式。

8. **安全性和可用性**

Passkey 技术在安全性和可用性方面表现优异:

- **密钥无需记忆**: 用户无需记忆复杂密钥,浏览器可发现并列出所有凭据供选择。
- **多因素认证**: 使用认证器时需要提供额外因素(如生物识别、PIN 码),实现内置的多重身份验证。
- **高度安全性**: 采用密钥加密算法,远比传统密码更加难以破解。设备绑定 Passkey 安全性最高。
- **优秀可用性**: 同步 Passkey 可在设备间自动同步,使用体验极佳,无需额外的密码管理工具。

9. **挑战和局限性**

尽管 Passkey 技术前景广阔,但仍面临一些挑战和局限性:

- **浏览器兼容性**: 不同浏览器对 WebAuthn 标准的实现可能存在差异,导致体验不一致。
- **隐私担忧**: 用户可能对依赖云服务存储私钥有隐私顾虑。
- **企业应用限制**: 一些企业可能由于政策或合规性原因,不允许使用云同步功能。
- **设备丢失风险**: 设备绑定 Passkey 无法恢复,设备丢失将导致凭据永久丢失。

总的来说,Passkey 是一种极具前景的无密码身份认证技术,它解决了传统密码认证存在的诸多安全性和可用性问题。虽然还面临一些挑战,但随着技术的不断发展和推广,Passkey 有望成为未来身份认证的主流方式,为用户带来更安全、更便捷的上网体验。