# 利用生成式 AI 与 OpenRewrite 自动化软件重构

**及时将代码库升级到最新技术栈**是维护系统健康和保持竞争力的关键。然而，随着代码库的增长和技术栈的频繁迭代，手动完成这一重构过程不仅耗时耗力，而且极其容易出现遗漏和失误。为了应对这一挑战，Moderne公司开发了 OpenRewrite 这一开源工具，并通过整合生成式人工智能大幅提升了代码重构和代码搜索的能力。

OpenRewrite 最初诞生于 3 年前，旨在实现 Spring 应用程序的自动化升级，包括将 Spring Boot 1.5 版本从 Java 8 无缝迁移至 Spring Boot 3.3 版本和 Java 17，同时集成 JUnit 5 和 Jakarta 等新特性。这一切都依赖于 OpenRewrite 开源社区共同维护的一系列规则集，即代码修改配方(recipes)。如今，这些配方的数量已超过 2500 个，覆盖了广泛的编程语言、框架和技术。

尽管手动编写配方大幅提高了代码迁移和重构的效率，但开发人员仍然面临着学习和搜索如此庞大配方库的挑战。如果无法快速找到所需的配方，甚至可能导致不必要的重复工作。因此，Moderne公司开始探索生成式人工智能(Generative AI)的能力，期望通过人工智能算法自动生成部分配方，从而降低人工编写成本，并提高配方库的完整性。

最初，Moderne公司抱有极高的期望，希望直接让人工智能生成全新配方。然而，早期实验发现生成的代码通常无法编译，存在语法错误和缺失方法等严重问题。此外，由于生成配方未遵循 OpenRewrite 框架的访问者模式，使得生成结果根本无法集成到现有系统中。显然，这种直接生成的方式存在着严重的可靠性问题，无法在生产环境中使用。

面对这一困境，Moderne公司逐步调整策略，将生成式人工智能的作用范围缩小至更有针对性和可控性的任务。例如，他们开发了一种使用长短期记忆(LSTM)深度学习模型的方法，可以准确检测和更正法语注释中的编码错误。这不仅提高了代码可读性，还解决了法语 Javadoc 生成失败的长期问题，为企业内部库的文档支持获得了极大改善。

在代码搜索方面，Moderne公司采用语义嵌入技术将配方和代码嵌入到矢量空间，并基于向量距离计算相似性匹配度。这种两阶段搜索范式可以大幅提高搜索速度和准确性。首先利用大型语言模型从所有潜在配方中快速检索出与查询最相关的候选配方，然后再通过参数化的实例化重新对这些候选配方进行精细排序。该系统已在 Modern 平台中集成，开发人员只需输入自然语言查询，便可快速找到所需的配方。

配方推荐是Moderne公司应用生成式人工智能的又一实践。他们开发了一种工作流程，通过聚类分析从大型代码库中抽取有代表性的方法定义样本，输入给生成式人工智能模型获取Moderne建议，再将这些建议与现有的配方库进行匹配，从而推荐出真正可运行的配方。这种方法避免了直接生成不可靠的代码更改，同时利用人工智能挖掘代码优化的潜在机会。

但是，即便将人工智能的作用范围缩小到可控范围，实现大规模部署仍然面临着巨大挑战。以配方推荐为例，一次典型的工作流可能需要处理数百万行代码、4000 个方法声明的样本输入。如果每个输入都需要几秒钟处理，整个流程可能需要数周时间才能完成。通过技术手段如向量化和聚类采样，Moderne公司将这一时间缩短至几分钟内。

Moderne公司在代码搜索领域同样做出了创新。他们面临的一个具体需求是，针对客户使用的某个身份访问管理(IAM)提供商，查找整个代码库中涉及该提供商 HTTP 头的所有方法调用，不仅跨越不同的 Web 客户端库(如Spring WebClient、OkHttp3等)，还包括各种方法实现和参数形式的差异。

为了高效搜索，他们先通过嵌入向量对所有方法调用进行排序，保留与用户查询最相关的前 500 个方法签名。然后在扫描代码时，只对这 500 个签名进行精细分析，而跳过其余大多数无关的方法调用。进一步的，他们链接了三个不同大小的语言模型，对最相关的调用进行级联分析和判断。这种分层过滤机制大幅减少了所需的模型推理计算，使整个搜索过程仅需几分钟即可完成。

Moderne公司在应用生成式人工智能的道路上遇到了诸多波折，但他们的实践结果令人鼓舞。通过有针对性地部署人工智能，将其作为可组合的"乐高积木"有机嵌入整个软件工具链，他们在确保生成结果的准确性和可靠性的同时，最大限度发挥了人工智能在代码分析、生成和搜索等环节的能力。

例如，在开发和集成生成式人工智能的搜索和推荐系统时，他们将人工智能模型的生成结果仅作为候选输入，再结合传统的检索和验证机制，从已有的配方库中精确定位可运行的配方。这种"AI辅助编程"范式同时发挥了人工智能的分析优势和人类判断的可靠性，以最小的成本获得了最佳效果。

对于生成式人工智能技术而言，Moderne公司的实践为我们展现了全新的编程范式。与其试图直接生成可执行的代码，不如将生成结果视为信息密集型的中间产品，再经过有针对性的处理和验证，转化为可靠的最终输出。这种工作模式不仅更加安全和高效，而且将人工智能的介入范围限制在更多可控环节，从而减轻了系统化风险。

同时，Moderne公司的实践也为软件生态系统的演进指明了方向。将来，可靠的生成式人工智能系统不应被视为一个整体，而是由众多微模块所组成的工具链条。每个模块专注于特定的分析或生成任务，例如语义嵌入、聚类采样、翻译、文本生成等。这些微模块的松耦合集成，不仅能降低整体系统的复杂度和风险，更重要的是可以缩短新模块或新算法上线所需的验证和测试周期。毫无疑问，这种面向未来的架构将为行业开发和集成下一代人工智能系统奠定基础。

总的来说，Moderne公司成功将生成式人工智能集成到 OpenRewrite 工具链中，在提升软件工程效率和准确率的同时，也为业界展示了应用人工智能的全新范式。与其目标性息息相关，这种结合人工智能与人类判断的混合策略，正逐步成为软件Moderne和代码重构的新常态。毫无疑问，在可见的将来，生成式人工智能将渗透到整个软件开发生命周期的各个环节，并帮助工程师们跨越代码世界中的新疆域。